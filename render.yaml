# ============================================================================
# RENDER DEPLOYMENT BLUEPRINT
# Intelligent Email Assistant — Production Infrastructure
# ============================================================================

services:
  # -------------------------------------------------------------------------
  # FRONTEND — Static Site (Vite + React)
  # -------------------------------------------------------------------------
  - type: static
    name: email-assistant-frontend
    runtime: node
    buildCommand: cd frontend && npm ci && npm run build
    publishDir: frontend/dist
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VITE_API_BASE
        sync: false
      - key: VITE_SOCKET_URL
        sync: false

  # -------------------------------------------------------------------------
  # BACKEND — Web Service (FastAPI + Socket.IO + Python 3.11)
  # -------------------------------------------------------------------------
  - type: web
    name: intelligent-email-assistant
    runtime: docker
    region: oregon
    plan: starter
    dockerfilePath: ./backend/Dockerfile
    dockerContext: .
    healthCheckPath: /healthz
    envVars:
      # --- Encryption & Security ---
      - key: FERNET_KEY
        sync: false
      - key: JWT_SECRET_KEY
        sync: false
      - key: JWT_ALGORITHM
        value: HS256
      - key: JWT_EXPIRE_MINUTES
        value: 60

      # --- Database (Supabase) ---
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false

      # --- Google OAuth (Gmail) ---
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: GCP_PROJECT_ID
        sync: false
      - key: GMAIL_PUBSUB_TOPIC
        sync: false

      # --- Microsoft OAuth (Outlook) ---
      - key: OUTLOOK_CLIENT_ID
        sync: false
      - key: OUTLOOK_CLIENT_SECRET
        sync: false

      # --- LLM Provider (Mistral AI) ---
      - key: MISTRAL_API_KEY
        sync: false
      - key: LLM_MODE
        value: api

      # --- OAuth Flow Configuration ---
      - key: BASE_URL
        sync: false
      - key: GOOGLE_REDIRECT_URI
        sync: false
      - key: ENVIRONMENT
        value: production

      # --- Redis (rate limiting, token cache, metrics) ---
      - key: REDIS_HOST
        sync: false
      - key: REDIS_PORT
        value: 6379

      # --- Secret File Paths (mounted via Render Secret Files) ---
      - key: GMAIL_CREDENTIALS_PATH
        value: /etc/secrets/gmail_credentials.json

      # --- Pub/Sub (Gmail push notifications) ---
      - key: PUBSUB_TOPIC_ID
        sync: false
      - key: PUBSUB_SUBSCRIPTION_ID
        sync: false

      # --- Application Config ---
      - key: LOG_LEVEL
        value: INFO
      - key: FRONTEND_URL
        sync: false
      - key: WORKER_MODE
        value: "true"

      # --- AI Summarization Worker ---
      - key: AI_SUMM_ENABLED
        value: "true"
      - key: AI_MODEL
        value: mistral-small-latest
      - key: AI_MAX_TOKENS
        value: 800
      - key: AI_TEMPERATURE
        value: 0.3
      - key: AI_MAX_CHARS
        value: 4000
      - key: AI_MAX_ATTEMPTS
        value: 5
      - key: AI_JOBS_BATCH
        value: 5
      - key: AI_IDLE_SLEEP
        value: 5

# ============================================================================
# DEPLOYMENT NOTES:
#
# 1. Current Service URLs:
#    - Backend: https://intelligent-email-assistant-3e1a.onrender.com
#    - Frontend: https://intelligent-email-frontend.onrender.com
#
# 2. Required Environment Variables in Render Dashboard (Backend):
#    - GOOGLE_CLIENT_ID = (from Google Cloud Console)
#    - GOOGLE_CLIENT_SECRET = (from Google Cloud Console)
#    - GOOGLE_REDIRECT_URI = https://intelligent-email-assistant-3e1a.onrender.com/auth/callback/google
#    - BASE_URL = https://intelligent-email-assistant-3e1a.onrender.com
#    - FRONTEND_URL = https://intelligent-email-frontend.onrender.com
#    - FERNET_KEY = (generate: python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())")
#    - JWT_SECRET_KEY = (generate random secure key)
#    - MISTRAL_API_KEY = (from Mistral AI - REQUIRED for AI summaries)
#    - SUPABASE_URL = (from Supabase)
#    - SUPABASE_ANON_KEY = (from Supabase)
#    - SUPABASE_SERVICE_KEY = (from Supabase)
#    - DATABASE_URL = (PostgreSQL connection string)
#    - ENVIRONMENT = production
#
# 3. Required Environment Variables in Render Dashboard (Frontend):
#    - VITE_API_BASE = https://intelligent-email-assistant-3e1a.onrender.com
#    - VITE_SOCKET_URL = https://intelligent-email-assistant-3e1a.onrender.com
#
# 4. Google Cloud Console Configuration:
#    - Authorized JavaScript Origins:
#      * https://intelligent-email-frontend.onrender.com
#    - Authorized Redirect URIs:
#      * https://intelligent-email-assistant-3e1a.onrender.com/auth/callback/google
#
# 5. Health check endpoint /health must return {"status": "ok"}
#
# 6. Package Structure:
#    - Backend root directory: backend/
#    - Start command runs from backend/ with proper Python module imports
#    - All imports use: from backend.module import ...
#
# 7. Worker Architecture (Hybrid Mode):
#    WORKER_MODE=true enables email sync worker (Gmail ingestion)
#    AI_SUMM_ENABLED=true enables AI summarization worker (Mistral-powered)
#    Both workers run as daemon threads in single Render web service
#
#    Worker Lifecycle:
#    - Email Worker: Syncs Gmail → writes to emails table
#    - AI Worker: Claims ai_jobs → calls Mistral → writes to email_ai_summaries
#
#    Queue Safety:
#    - Atomic job claiming via ai_claim_jobs RPC (FOR UPDATE SKIP LOCKED)
#    - Idempotent enqueue: UNIQUE (job_type, account_id, gmail_message_id)
#    - Idempotent results: UNIQUE (account_id, gmail_message_id, prompt_version)
#    - Retry cap: 5 attempts with exponential backoff → dead-letter queue
#
#    Monitoring:
#    - Check ai_jobs table for status='dead' (failed after 5 attempts)
#    - Monitor email_ai_summaries for new entries (successful summaries)
#    - Watch logs for [AI-WORKER] lifecycle events
# ============================================================================

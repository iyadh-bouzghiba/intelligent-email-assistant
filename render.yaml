# ============================================================================
# RENDER DEPLOYMENT BLUEPRINT
# Intelligent Email Assistant — Production Infrastructure
# ============================================================================

services:
  # -------------------------------------------------------------------------
  # FRONTEND — Static Site (Vite + React)
  # -------------------------------------------------------------------------
  - type: static
    name: email-assistant-frontend
    runtime: node
    buildCommand: cd frontend && npm install && npm run build
    publishDir: frontend/dist
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VITE_API_BASE
        sync: false
      - key: VITE_SOCKET_URL
        sync: false

  # -------------------------------------------------------------------------
  # BACKEND — Web Service (FastAPI + Socket.IO + Python 3.11)
  # -------------------------------------------------------------------------
  - type: web
    name: email-assistant-backend
    runtime: python
    region: oregon
    plan: starter
    buildCommand: cd backend && pip install -r requirements.txt
    startCommand: cd backend && python -m backend.src.infrastructure.worker_entry
    healthCheckPath: /health
    envVars:
      # --- Encryption & Security ---
      - key: FERNET_KEY
        sync: false
      - key: JWT_SECRET_KEY
        sync: false
      - key: JWT_ALGORITHM
        value: HS256
      - key: JWT_EXPIRE_MINUTES
        value: 60

      # --- Database (Supabase) ---
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_KEY
        sync: false
      - key: DATABASE_URL
        sync: false

      # --- Google OAuth (Gmail) ---
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: GCP_PROJECT_ID
        sync: false
      - key: GMAIL_PUBSUB_TOPIC
        sync: false

      # --- Microsoft OAuth (Outlook) ---
      - key: OUTLOOK_CLIENT_ID
        sync: false
      - key: OUTLOOK_CLIENT_SECRET
        sync: false

      # --- LLM Provider (Mistral AI) ---
      - key: MISTRAL_API_KEY
        sync: false
      - key: LLM_MODE
        value: api

      # --- OAuth Flow Configuration ---
      - key: OAUTH_REDIRECT_BASE_URL
        sync: false
      - key: BASE_URL
        sync: false
      - key: REDIRECT_URI
        sync: false

      # --- Application Config ---
      - key: LOG_LEVEL
        value: INFO
      - key: FRONTEND_URL
        sync: false
      - key: WORKER_MODE
        value: false

# ============================================================================
# DEPLOYMENT NOTES:
#
# 1. Backend Service URL will be: https://email-assistant-backend.onrender.com
# 2. Frontend Service URL will be: https://email-assistant-frontend.onrender.com
#
# 3. Set these environment variables in Render Dashboard:
#    - VITE_API_BASE = https://email-assistant-backend.onrender.com
#    - VITE_SOCKET_URL = https://email-assistant-backend.onrender.com
#    - FRONTEND_URL = https://email-assistant-frontend.onrender.com
#    - OAUTH_REDIRECT_BASE_URL = https://email-assistant-backend.onrender.com
#    - BASE_URL = https://email-assistant-backend.onrender.com
#    - REDIRECT_URI = https://email-assistant-backend.onrender.com/auth/google/callback
#
# 4. Generate FERNET_KEY locally and add to Render:
#    python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
#
# 5. Copy all secrets from backend/.env to Render environment variables
#
# 6. Health check endpoint /health must return 200 for service to be healthy
#
# 7. Free tier limitations:
#    - Services spin down after 15 minutes of inactivity
#    - Cold start time: ~30 seconds
#    - Recommend upgrading to Starter plan for production workloads
# ============================================================================
